# 결제 시스템 설계

# 요구사항

- 이벤트를 준비해야하는데 초당 1000개의 결제 요청이 예상됨
- 외부 PG사는 초당 100의 요청만 처리
- 돈이걸려있어서 정합성이 중요

# 시스템 아키텍처

<img src='https://user-images.githubusercontent.com/66231761/169519674-43374518-2bb2-45df-b4d0-d01b5207ee0d.jpeg' width='600'/>

# 애플리케이션 서버 다중화

- 하나의 서버에 장애가 나더라도 다른 서버로 트래픽을 돌리고 장애 복구시 다시 원상복구할 수 있기 때문에 웹 사이트 전체가 다운되는 일을 방지할 수 있습니다.
- 트래픽 유입량에 따라 유동적으로 서버를 증설, 감소 할 수 있습니다.

# Database 다중화

- master-slave 모델로 원본은 master 서버에, 사본은 부 서버에 저장합니다. insert, update, delete와 같은 쓰기 연산은 master 에만 전달되고 읽기 연산은 slave 에만 전달됩니다.
    - 병렬로 처리할 수 있는 쿼리 수가 증가합니다.
    - DB 서버중 일부가 파괴되어도 나머지 서버를 가용할 수 있습니다.
- Sharding을 사용해서 대규모 데이터베이스를 샤드 단위로 분할할 수 있습니다. 모든 샤드는 스키마는 같지만 샤딩 키에 따라 보관되는 위치가 다릅니다.
    - 병렬로 처리할 수 있는 쿼리 수가 증가합니다.

# Message Queue

- 메시지 큐는 Producer-Consumer 패턴을 기반으로 동작합니다.
- 생산자가 발행한 메시지는 소비자가 소비할 때까지 큐에 저장되기 때문에 무손실을 보장합니다.
- 메시지를 큐에 저장해놨다가 비동기로 처리할 수 있습니다.
- 생산자 서비스와 소비자 서비스 사이에 브로커를 두는 방식이므로 각각 독립적으로 확장하기 용이합니다.

# 발생 가능한 이슈

- PG사에서 제공하는 http api 형태의 인터페이스를 Message Queue를 통해 통신할 수 있는가?
    - 웹기반 메시징 API를 지원하는 ActiveMQ를 사용한다.
- 비동기형태로 메시지를 줄텐데 유저가 결제가 완료 되었다는것을 어떻게 전달 할수있을까?
    - 메시지가 언제 처리될지 알 수 없으므로 콜백 함수를 등록한다.
- 만약 최대 결제횟수가 정해져있고 최대 결제 횟수보다 메시지 큐에 저장된 요청이 더 많다면?
    - 메시지 큐에서 FIFO방식으로 순차적으로 처리해야하고 초과된 요청은 반려해야함
